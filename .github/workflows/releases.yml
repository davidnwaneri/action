name: Release Draft
on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened
      - edited


  push:
    branches:
      - main

permissions: write-all

jobs:
  semantic-pull-request:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  draft-release:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.set-output.outputs.tag }}
      url: ${{ steps.set-output.outputs.url }}
    steps:
      - name: Draft release
        uses: release-drafter/release-drafter@v5
        id: release-drafter
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - run: echo ${{ steps.release-drafter.outputs.tag_name }}
      - name: Set output
        id: set-output
        run: |
          echo "tag='${{ steps.release-drafter.outputs.tag_name }}'" >> $GITHUB_OUTPUT
          echo "url='${{ steps.release-drafter.outputs.html_url }}'" >> $GITHUB_OUTPUT
  bump-version-pr:
    permissions: write-all
    needs: draft-release
    runs-on: ubuntu-latest
    if: contains(needs.draft-release.outputs.url, 'untagged')
#    && github.event.pull_request.merged == true
    env:
      TAG: ${{ needs.draft-release.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - uses: tibdex/github-app-token@v1
        id: generate-token
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}
      - name: Bump version
        uses: mikefarah/yq@master
        with:
#          cmd: yq -i '.version = [${{ env.TAG }}] pubspec.yaml
          cmd: yq -i '.version = (${{ env.TAG }}).match('^\d+\.\d+\.\d+(?:[+-]\S+)?$')' pubspec.yaml
      - name: Create Pull Request to bump version in pubspec.yaml
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ steps.generate-token.outputs.token }}
          branch: "bump-pubspec-version"
          commit-message: "build: bump pubspec version to ${{ env.TAG }}"
          title: "build: bump pubspec version to ${{ env.TAG }}"
          labels: "bump-pubspec-version"
          reviewers: "davidnwaneri"
          assignees: "davidnwaneri"

#  check-for-draft-release:
#    needs: draft-release
#    runs-on: ubuntu-latest
#    outputs:
#      draft-is-present: ${{ steps.check-for-draft-release.outputs.draft }}
#      tag: ${{ steps.check-for-draft-release.outputs.tag }}
#    env:
#      TAG: ${{ needs.draft-release.outputs.tag }}
#    steps:
##      - name: Checkout code
##        uses: actions/checkout@v3
#      - uses: cardinalby/git-get-release-action@v1
#        id: git-get-release
#        env:
#          GITHUB_TOKEN: ${{ github.token }}
#        with:
#          draft: true
#          doNotFailIfNotFound: true
#          releaseName: ${{ needs.draft-release.outputs.tag }}
##          tag: ${{ needs.draft-release.outputs.tag }}
#      - name: Check for draft release
#        id: check-for-draft-release
#        run: |
#          echo "draft='${{ steps.git-get-release.outputs.draft }}'" >> $GITHUB_OUTPUT
#          echo "tag='${{ steps.git-get-release.outputs.tag_name }}'" >> $GITHUB_OUTPUT
#          echo ${{ steps.git-get-release.outputs.draft }}
#          echo ${{ steps.git-get-release.outputs.id }}
#          echo ${{ steps.git-get-release.outputs.node_id }}
#          echo ${{ steps.git-get-release.outputs.tag_name }}
#          echo ${{ steps.git-get-release.outputs.name }}

#      - name: Check for draft release
#        id: check-for-draft-release
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#        run: |
#          echo 'Checking for draft release'
#          tag=$(gh release list | grep -n $TAG)
#          draft=$(gh release list | grep -in draft)
#
#          echo $tag
#          echo $draft
#
#          echo "Running conditionals"
#          if [[ $tag == $draft ]]; then
#            echo "First conditional true"
#            echo "tag=$TAG" >> $GITHUB_OUTPUT
#            echo "draft=true" >> $GITHUB_OUTPUT
#            exit 0
#          else
#            echo "Second conditional true"
#            echo "tag=$TAG" >> $GITHUB_OUTPUT
#            echo "draft=false" >> $GITHUB_OUTPUT
#          fi
#          echo "Finished conditionals"

#  log:
#    needs: draft-release
#    runs-on: ubuntu-latest
#    steps:
#      - run: echo ${{ needs.draft-release.outputs.tag }}


#  changelog:
##    name: Conventional Changelog Action
#    needs: semantic-pull-request
#    runs-on: ubuntu-latest
#    steps:
#      - name: checkout
#        uses: actions/checkout@v3
#      - run: echo ${{ github.ref }}
#      - uses: "TriPSs/conventional-changelog-action@v3"
#        with:
#          github-token: ${{ secrets.github_token }}
##          git-message: 'chore(release): {version}'
##          git-user-name: 'Awesome Changelog Action'
##          git-user-email: 'awesome_changelog@github.actions.com'
##          preset: 'angular' # default
##          tag-prefix: 'v' # default
##          output-file: CHANGELOG.md # default
#          release-count: '0'
#          version-file: ./pubspec.yaml
##          version-path: 'version' # default
#          skip-on-empty: false
##          skip-version-file: false # default
##          skip-commit: false # default
##          git-branch: main